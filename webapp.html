<html>



<head>

<!--<link rel="stylesheet" type="text/css" href="mystyle.css">-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>



<style>

.sorting-arrow-up{
	 position:absolute;
	 top:0px;	
}

.sorting-arrow-down{
	position:absolute;
	top:10px;
}


.glyphicon-small {
	font-size:8px;
}

.glyphicon-small:hover{
	cursor:pointer;
}

.sorting-arrows {
	position:relative; 
	float:right;
}

.display-animals th {
	background-color: #FF7148;
	color:white;
}

</style>



</head>


<body onload="makeRequest()">


<script>


	var _headerValues;
	


	empty = function (data) {
		return data;
	}
	
	sortObjects = function (data){
		
		var sortKeys=[];
		$.each(data, function(index , value){
			if (!sortKeys.contains(value))
				sortKeys.push(value);
		});					
		sortKeys.sort();
		console.log(sortKeys);
		
	}

	pad = function(n) { 
		return n < 10 ? ("0" + n) : n; 
	}
	
	formatDate = function(unformattedDate, html5){
	
			var d = new Date(unformattedDate);		

			if (typeof html5=='undefined'){
				//month is offset by one in getMonth .i.e it starts at 0
				var formatedDate= pad(d.getDate())+"/"+pad((d.getMonth()+1))+"/"+d.getFullYear();
				
			}else{
				var formatedDate= d.getFullYear()+"-"+pad((d.getMonth()+1))+"-"+pad(d.getDate());
			}
			
			return formatedDate;
	}

	
	
	
	appendRow = function(rowIndex,rowData, changeColums) {	
			//TODO some basic error checking
			//Make a flexible table?
			$('.display-animals tbody').append("<tr id='"+rowIndex+"'></tr>");
			var tr = $(".display-animals tr#"+rowIndex);
			
			for (var i = 0; i < _headerValues.length; i++) {
			
				if (typeof changes !== 'undefined' && changes[i]){
						tr.append('<td>'+changes[i](rowData[_headerValues[i]])+'</td>');	
					}
					else{	
						tr.append('<td>'+rowData[_headerValues[i]]+'</td>');	
					}
			}			
	}
	
	
	
	linkToDetails= function(data){
		return '<button  type="button" class="btn btn-primary"  data-toggle="modal" data-target="#myModal" onClick="getDetails('+data+')" >Details</button>';
	}
	
	getDetails= function(data){
		
		//remove the previous jsonp call since it is not needed
		$( "#animal_detail" ).remove();
		
		var script= document.createElement('script');
		script.id="animal_detail"
		script.type= 'text/javascript';
		script.src= dataUrl+'/detail/'+data+'?callback=insertDetails'; 
		$('head').append(script);	  
	}
	
	makeRequest = function(){	
      var script= document.createElement('script');
      script.type= 'text/javascript';
      script.src= dataUrl+'?callback=buildTable'; 
	  $('head').prepend(script);
	}
	
	var dataUrl='https://tasks.inlogik.com/devtest/animals';
	
	insertDetails= function(data){
	

		$('input#nameInput').attr("value",data.name);
		$('input#typeInput').attr("value",data.type);
		$('input#birthdayInput').attr("value",formatDate(data.birthday,true));
		$('input#weightInput').attr("value",data.weight);
		
		if (data.hasHorns)
			$('input#hasHornsInput').attr("checked","checked");
		else
			$('input#hasHornsInput').removeAttr( "checked" );
			
	}
	
	
	convertBooltoCheckbox = function(data){
		return '<input type="checkbox" disabled '+((data)? 'checked' : "")+'/>';
	}
	
	
	
	
	
	addTableHeader = function (headerTitles){
		
		orderedValues=[];
		
		if (typeof sortColums === 'undefined'){
				_headerValues=headerTitles;
			}
		else{
				
				for (var i=0; i<headerTitles.length;i++){
				console.log(headerTitles[sortColums[i]]);
					orderedValues.push(headerTitles[sortColums[i]]);
				}
		
				_headerValues=orderedValues;
			}
			
		console.log(_headerValues);
		
		$('.display-animals thead').append("<tr></tr>");
		
		var tr = $(".display-animals thead tr");
		
				var headers=getHeaderLabels();
				for (var i = 0; i < headers.length; i++) {
						tr.append('<th>'+headers[i].capitalize()+'<span class="sorting-arrows">'
						+'<span class="glyphicon glyphicon-chevron-up glyphicon-small sorting-arrow-up" aria-hidden="true" onclick="sortTable('+i+',false)"></span>'
						+'<span class="glyphicon glyphicon-chevron-down glyphicon-small sorting-arrow-down" aria-hidden="true"  onclick="sortTable('+i+',true)"></span>'				
						+'</span>'+						
						'</th>');
						
						
						
				}
	}
	
	String.prototype.capitalize = function() {
		return this.charAt(0).toUpperCase() + this.slice(1);
	}
	
	
	getHeaderLabels= function (){
				if (typeof headerLabels !== 'undefined'){
				
				
					var fetchedLabels=[];
							
					for (var i=0; i< _headerValues.length;i++){
							fetchedLabels.push(_headerValues[i]);			
					}
					
					//if custom header labels are defined replace the existing ones
					$.each(headerLabels, function(key, value) {
						fetchedLabels[key]= value;
					});
					
					return fetchedLabels;
					
				}	else {				
						return _headerValues;
				}
	}

	buildTable = function(data){
	
	
		if (checkIntegrity(data)){
		
			//reorder keys
			addTableHeader(getKeys(data[0]));
			$.each(data, appendRow);	
		}
		else{
			alert("ERROR: You have errors with data integrity\nPlease supply properly formatted JSON array of objects");
		}
	}
	

	checkIntegrity = function (data){
		
		try {
		var keys= getKeys(data[0]);
		$.each(data, function(key, value) {
			
			for (var i = 0; i < keys.length; i++) {
						if(!value.hasOwnProperty(keys[i]))
							return false;
				}
		});
		return true;
		
		}catch(err){		
			return false;
		}
	}
	
	//gets the keys of an object
	getKeys = function(obj){
		var keys=[];
		
		$.each(obj, function(key, value) {
			keys.push(key);
		});
		return keys;
	}

 
	searchTable = function(){

		var	defaultCol;
		if (typeof searchableColumn == 'undefined') {
				defaultCol=1;
			}else if (searchableColumn<1){
				searchableColumn=1;
				defaultCol=searchableColumn;
			} else{
				defaultCol=searchableColumn;
			}
		
	
		
		var input =$('#searchInput').val();
		
		if (input==""){
			$(".display-animals tr").removeAttr("style");
			return;
		}
		var regex = new RegExp(input, "i");
		$( ".display-animals tr td:nth-child("+defaultCol+")" ).each(function (index){	
			if ($(this).text().search(regex)==-1){
				$(this).parent().css("display","none");
			}else{
				$(this).parent().removeAttr("style");
			}
		}
		
		);
	
		
	
	}
	
	
	sortTable = function ( col, reverse) {
	
		var table = document.getElementById("main-table");

		var tb =table.tBodies[0] , //table.tBodies[0], // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
			tr = Array.prototype.slice.call(tb.rows, 0), // put rows into array
			i;
		reverse = -((+reverse) || -1);
		tr = tr.sort(function (a, b) { // sort rows
	
		var atext=	a.cells[col].textContent.trim();
		var btext =	b.cells[col].textContent.trim();

	//loose interpretation as date
	if (atext.split('/').length==3 && 
		btext.split('/').length==3 &&
		atext.length==10 &&
		btext.length==10){
		
		var date1ar= atext.split('/');		
		var atextRev= date1ar[2]+"/"+date1ar[1]+"/"+date1ar[0];
		var date2ar= btext.split('/');				
		var btextRev= date2ar[2]+"/"+date2ar[1]+"/"+date2ar[0];		
		return reverse * (atextRev.localeCompare(btextRev));
	}
	else if (isNaN(atext) && isNaN(btext)  ){
        return reverse * (atext.localeCompare(btext));
	}
		
	else {
		return reverse * (parseInt(atext)-parseInt(btext));
	}
		
    });
    for(i = 0; i < tr.length; ++i) tb.appendChild(tr[i]); // append each row in order
	}


 
	//delete this to display normal unformatted table
	//this are case specific variables if you comment them you can get this system to display anything
		var headerLabels = {5:"Action"};
		var sortColums= [1,3,2,4,5,0];
		var changes={3:formatDate,4:convertBooltoCheckbox,5:linkToDetails};
		var searchableColumn = 2;
		var searchableColumn = 2;
		
	fd = function (data){
		
		return "12/34/6676";
	
	}
	
	//sortColums=[3,4,1,5,2,0];
	
	//var headerLabels ={5:"HJORNS"};

	//var changes={4:fd};
	
</script>

 


<div class="container">


 <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">Home</a></li>
    <li role="presentation"><a href="#about" aria-controls="about" role="tab" data-toggle="tab">Read Me Please!</a></li>
  </ul>

  
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="home">
   
  <h2>Home <small><i>this code makes use of JSONP and CDN links</i></small></h3>
  <h5 class="text-danger">Please read the "Read Me Please" page</h5>
  
 <form  class="form-inline" role="search">
        <div class="form-group">
          <input type="text" class=" form-control" placeholder="Search" id="searchInput">
        </div>
      
			<button type="button" class="btn btn-success" onclick="searchTable()">
				<span class="glyphicon glyphicon-search" aria-hidden="true"></span> Submit
			</button>
      </form>
	  


	  
	  <!-- Large modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Details<h4>
      </div>
      <div class="modal-body">
       
	   <form class="form-horizontal" role="form">
	<div class="form-group">
		<label for="nameInput" class="col-sm-2 control-label">Name</label>
		<div class="col-sm-10">
		<input type="text" class="form-control" id="nameInput" placeholder="Name">
		</div>
	</div>
  <div class="form-group">
    <label for="typeInput" class="col-sm-2 control-label">Type</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="typeInput" placeholder="Type">
    </div>
  </div>
  
   <div class="form-group">
    <label for="birthdayInput" class="col-sm-2 control-label">Birthday</label>
    <div class="col-sm-10">
      <input type="date" class="form-control" id="birthdayInput" >
    </div>
  </div>
   <div class="form-group">
    <label for="weightInput" class="col-sm-2 control-label">Weight</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="weightInput" placeholder="Weight">
    </div>
  </div>
  
  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <div class="checkbox">
        <label>
          <input type="checkbox" id="hasHornsInput"> Has Horns
        </label>
      </div>
    </div>
  </div>
  
</form>
	   
	   
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

	  
<table id="main-table" class="display-animals table table-striped">
<thead>
	
	</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
 <div role="tabpanel" class="tab-pane" id="about"><h2>About</h2>
 
 <div>
 <h4>The Good</h4>
 <ul >
  <li >Implemented with Twitter Bootstrap</li>
  <li >Makes use of HTML5 controls</li>
  <li >Separate arrows for sorting up/down for convenience </li>
  <li >Use of JQuery</li>
  <li >Pop-up Modal for details</li>
  <li >The code is made to work with other data of this type it relies on the first object fetched and checks if it's similar to the others 
	<ul>
	 <li ><strong>It contains 4 variables if you comment 3 of them excluding "searchColumn" you will get a basic table with the same data with both search and sort still working </strong> </li>
			
				<ul>
					<li>"headerLabels" an array that contains Strings to replace the original column names, parsed from the JSON data </li>
					<li>"sortColums" an array that defines the ordering of the columns if its not the same as the original data </li>
					<li>"changes" An array that contains a list of function names to be applied to each column</li>
					<li class="text-danger">"searchColumn" An integer that indicates which column to search (can be changed to search by name for example)</li>				
				</ul>
		<h5 class="text-success"><strong>The idea is to offer a lot of flexibility, some other unrelated data can be fetched and manipulated (on display) using these variables</strong></h5>
	</ul>
  </li>
  
</ul>
 </div>
 
 <div>
  <h4>The Bad</h4>
  <ul>
	<li>Minimal checks cross-browser compatibility but works best in Chrome</li>
	<li>Minimal checks for data-integrity</li>
	<li>Some loose assumptions made in a few places</li>
	<li>Next to nil exception handling</li>
	<li>Hard to read and Messy Code</li>
	<li>"The Details" page as opposed to the table is bound to the "animals" dataset (I really wanted to make it generic but I ran out of time)</li>
	<h5 class="text-danger"><strong>Please note that this is all due to time constraints and work commitments, if you contact me I will find some other excuses :)</strong></h5>
  </ul>
 </div>
 
 </div>
	</div>

</div>
</body>

</html>
